const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');

// ะะพะฝัะธะณััะฐัะธั
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '8275935313:AAEJ6O8HN_6r6X-XRzzRpuWwb8jC883yn8o';
const WEBSITE_URL = process.env.WEBSITE_URL || 'https://expensive-finance.vercel.app';

// ะกะพะทะดะฐะฝะธะต ะฑะพัะฐ
const bot = new TelegramBot(BOT_TOKEN, { polling: true });

// ะกะพััะพัะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
const userStates = new Map();

// ะะปะฐะฒะฝะพะต ะผะตะฝั
const mainMenu = {
  reply_markup: {
    keyboard: [
      ['๐ฐ ะัะตะดะธัั', '๐ฆ ะะตะฟะพะทะธัั'],
      ['๐ ะะฐะปัะบัะปััะพั', '๐ ะะพะฝัะฐะบัั'],
      ['โน๏ธ ะ ะบะพะผะฟะฐะฝะธะธ', '๐ ะะฐั ัะฐะนั']
    ],
    resize_keyboard: true,
    one_time_keyboard: false
  }
};

// ะัะตะดะธัะฝะพะต ะผะตะฝั
const creditMenu = {
  reply_markup: {
    keyboard: [
      ['๐ ะญะบัะฟัะตัั ะบัะตะดะธั', '๐ ะะฟะพัะตะบะฐ'],
      ['๐ ะะฒัะพะบัะตะดะธั', '๐ผ ะะธะทะฝะตั ะบัะตะดะธั'],
      ['๐ ะะฐะทะฐะด ะฒ ะผะตะฝั']
    ],
    resize_keyboard: true,
    one_time_keyboard: false
  }
};

// ะะตะฟะพะทะธัะฝะพะต ะผะตะฝั
const depositMenu = {
  reply_markup: {
    keyboard: [
      ['๐ ะะฐัะผะตั ะดะตะฟะพะทะธั', '๐ ะัะตะผะธัะผ ะดะตะฟะพะทะธั'],
      ['๐ ะกัะพัะฝัะน ะดะตะฟะพะทะธั', '๐ ะะพะฟะพะปะฝัะตะผัะน'],
      ['๐ ะะฐะทะฐะด ะฒ ะผะตะฝั']
    ],
    resize_keyboard: true,
    one_time_keyboard: false
  }
};

// ะะฑัะฐะฑะพัะบะฐ ะบะพะผะฐะฝะดั /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name;
  
  const welcomeMessage = `
๐ ะัะธะฒะตั, ${firstName}!

ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ Expensive Finance! 
ะฏ ะฟะพะผะพะณั ะฒะฐะผ ั ัะธะฝะฐะฝัะพะฒัะผะธ ะฒะพะฟัะพัะฐะผะธ.

ะัะฑะตัะธัะต ะธะฝัะตัะตััััะธะน ะฒะฐั ัะฐะทะดะตะป:
  `;
  
  bot.sendMessage(chatId, welcomeMessage, mainMenu);
});

// ะะฑัะฐะฑะพัะบะฐ ัะตะบััะพะฒัั ัะพะพะฑัะตะฝะธะน
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  const userId = msg.from.id;
  
  // ะกะพััะฐะฝัะตะผ ัะพััะพัะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
  if (!userStates.has(userId)) {
    userStates.set(userId, 'main');
  }
  
  const userState = userStates.get(userId);
  
  switch (text) {
    case '๐ฐ ะัะตะดะธัั':
      userStates.set(userId, 'credits');
      bot.sendMessage(chatId, '๐ณ ะัะฑะตัะธัะต ัะธะฟ ะบัะตะดะธัะฐ:', creditMenu);
      break;
      
    case '๐ฆ ะะตะฟะพะทะธัั':
      userStates.set(userId, 'deposits');
      bot.sendMessage(chatId, '๐ฆ ะัะฑะตัะธัะต ัะธะฟ ะดะตะฟะพะทะธัะฐ:', depositMenu);
      break;
      
    case '๐ ะะฐะปัะบัะปััะพั':
      bot.sendMessage(chatId, 
        `๐งฎ ะะปั ัะฐััะตัะฐ ะบัะตะดะธัะฐ ะฟะตัะตะนะดะธัะต ะฝะฐ ะฝะฐั ัะฐะนั:\n\n${WEBSITE_URL}/#credit-calculator\n\nะขะฐะผ ะฒั ะฝะฐะนะดะตัะต ัะดะพะฑะฝัะน ะบะฐะปัะบัะปััะพั ั ะธะฝัะตัะฐะบัะธะฒะฝัะผะธ ัะปะฐะนะดะตัะฐะผะธ!`,
        {
          reply_markup: {
            inline_keyboard: [[
              { text: '๐ ะัะบัััั ะบะฐะปัะบัะปััะพั', url: `${WEBSITE_URL}/#credit-calculator` }
            ]]
          }
        }
      );
      break;
      
    case '๐ ะะพะฝัะฐะบัั':
      bot.sendMessage(chatId, 
        `๐ ะะฐัะธ ะบะพะฝัะฐะบัั:\n\n๐ฑ ะขะตะปะตัะพะฝ: +7 (777) 123-45-67\n๐ง Email: info@expensive-finance.com\n๐ฌ WhatsApp: +7 (777) 123-45-67\n๐ฑ Telegram: @expensive_finance\n\n๐ ะะฐะฑะพัะฐะตะผ: 9:00 - 21:00 (ะตะถะตะดะฝะตะฒะฝะพ)`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะะพะทะฒะพะฝะธัั', url: 'tel:+77771234567' }],
              [{ text: '๐ฌ WhatsApp', url: 'https://wa.me/77771234567' }],
              [{ text: '๐ง Email', url: 'mailto:info@expensive-finance.com' }]
            ]
          }
        }
      );
      break;
      
    case 'โน๏ธ ะ ะบะพะผะฟะฐะฝะธะธ':
      bot.sendMessage(chatId, 
        `๐ข ะ ะบะพะผะฟะฐะฝะธะธ Expensive Finance:\n\nโ ะะธัะตะฝะทะธัะพะฒะฐะฝะฝะฐั ัะธะฝะฐะฝัะพะฒะฐั ะพัะณะฐะฝะธะทะฐัะธั\nโ ะะฐะฑะพัะฐะตะผ ั 2018 ะณะพะดะฐ\nโ ะะพะปะตะต 10,000 ะดะพะฒะพะปัะฝัั ะบะปะธะตะฝัะพะฒ\nโ ะะดะพะฑัะตะฝะธะต ะบัะตะดะธัะฐ ะทะฐ 24 ัะฐัะฐ\nโ ะะฝะดะธะฒะธะดัะฐะปัะฝัะน ะฟะพะดัะพะด ะบ ะบะฐะถะดะพะผั ะบะปะธะตะฝัั\n\n๐ฏ ะะฐัะฐ ะผะธััะธั - ะฟะพะผะพัั ะบะฐะถะดะพะผั ะฟะพะปััะธัั ะฝะตะพะฑัะพะดะธะผัะต ัะธะฝะฐะฝัะพะฒัะต ััะปัะณะธ!`,
        {
          reply_markup: {
            inline_keyboard: [[
              { text: '๐ ะะพะดัะพะฑะฝะตะต ะฝะฐ ัะฐะนัะต', url: `${WEBSITE_URL}/about` }
            ]]
          }
        }
      );
      break;
      
    case '๐ ะะฐั ัะฐะนั':
      bot.sendMessage(chatId, 
        `๐ ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฝะฐ ะฝะฐั ัะฐะนั!\n\nะขะฐะผ ะฒั ะฝะฐะนะดะตัะต:\nโข ๐ ะัะตะดะธัะฝัะน ะบะฐะปัะบัะปััะพั\nโข ๐ ะะฝะปะฐะนะฝ ะทะฐัะฒะบะธ\nโข ๐ ะะบััะฐะปัะฝัะต ััะฐะฒะบะธ\nโข ๐ ะะพะฝัะฐะบัะฝัั ะธะฝัะพัะผะฐัะธั\n\nะะตัะตัะพะดะธัะต ะธ ะธะทััะฐะนัะต ะฝะฐัะธ ััะปัะณะธ!`,
        {
          reply_markup: {
            inline_keyboard: [[
              { text: '๐ ะัะบัััั ัะฐะนั', url: WEBSITE_URL }
            ]]
          }
        }
      );
      break;
      
    // ะัะตะดะธัะฝัะต ะฟัะพะดัะบัั
    case '๐ ะญะบัะฟัะตัั ะบัะตะดะธั':
      bot.sendMessage(chatId, 
        `๐ ะญะบัะฟัะตัั ะบัะตะดะธั:\n\n๐ฐ ะกัะผะผะฐ: ะดะพ 3,000,000 โธ\nโฐ ะกัะพะบ: ะดะพ 36 ะผะตัััะตะฒ\n๐ ะกัะฐะฒะบะฐ: ะพั 13,10% ะณะพะดะพะฒัั\nโก ะะดะพะฑัะตะฝะธะต: ะทะฐ 24 ัะฐัะฐ\n\nโ ะะตะท ัะฟัะฐะฒะพะบ ะพ ะดะพัะพะดะฐั\nโ ะะฝะปะฐะนะฝ ะทะฐัะฒะบะฐ\nโ ะััััะพะต ัะตัะตะฝะธะต\n\nะฅะพัะธัะต ะฟะพะดะฐัั ะทะฐัะฒะบั?`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะะพะดะฐัั ะทะฐัะฒะบั', url: `${WEBSITE_URL}/#application` }],
              [{ text: '๐งฎ ะะฐัััะธัะฐัั ะฟะปะฐัะตะถ', url: `${WEBSITE_URL}/#credit-calculator` }]
            ]
          }
        }
      );
      break;
      
    case '๐ ะะฟะพัะตะบะฐ':
      bot.sendMessage(chatId, 
        `๐ ะะฟะพัะตัะฝัะน ะบัะตะดะธั:\n\n๐ฐ ะกัะผะผะฐ: ะดะพ 50,000,000 โธ\nโฐ ะกัะพะบ: ะดะพ 25 ะปะตั\n๐ ะกัะฐะฒะบะฐ: ะพั 8,50% ะณะพะดะพะฒัั\n๐ก ะะตัะฒะพะฝะฐัะฐะปัะฝัะน ะฒะทะฝะพั: ะพั 20%\n\nโ ะะธะทะบะฐั ััะฐะฒะบะฐ\nโ ะะพะปะณะพััะพัะฝัะน ะฟะตัะธะพะด\nโ ะะพััะดะฐัััะฒะตะฝะฝะฐั ะฟะพะดะดะตัะถะบะฐ\nโ ะกััะฐัะพะฒะฐะฝะธะต ะฒ ะฟะพะดะฐัะพะบ\n\nะะฝัะตัะตััะตั ะธะฟะพัะตะบะฐ?`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะะพะดะฐัั ะทะฐัะฒะบั', url: `${WEBSITE_URL}/#application` }],
              [{ text: '๐งฎ ะะฐัััะธัะฐัั ะฟะปะฐัะตะถ', url: `${WEBSITE_URL}/#credit-calculator` }]
            ]
          }
        }
      );
      break;
      
    case '๐ ะะฒัะพะบัะตะดะธั':
      bot.sendMessage(chatId, 
        `๐ ะะฒัะพะบัะตะดะธั:\n\n๐ฐ ะกัะผะผะฐ: ะดะพ 15,000,000 โธ\nโฐ ะกัะพะบ: ะดะพ 7 ะปะตั\n๐ ะกัะฐะฒะบะฐ: ะพั 9,90% ะณะพะดะพะฒัั\n๐ ะะตะท ะฟะตัะฒะพะฝะฐัะฐะปัะฝะพะณะพ ะฒะทะฝะพัะฐ\n\nโ ะััััะพะต ะพัะพัะผะปะตะฝะธะต\nโ ะกััะฐัะพะฒะบะฐ ะฒ ะฟะพะดะฐัะพะบ\nโ ะัะณะพะดะฝัะต ััะปะพะฒะธั\nโ ะจะธัะพะบะธะน ะฒัะฑะพั ะฐะฒัะพ\n\nะะพัะพะฒั ะบัะฟะธัั ะฐะฒัะพะผะพะฑะธะปั?`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะะพะดะฐัั ะทะฐัะฒะบั', url: `${WEBSITE_URL}/#application` }],
              [{ text: '๐งฎ ะะฐัััะธัะฐัั ะฟะปะฐัะตะถ', url: `${WEBSITE_URL}/#credit-calculator` }]
            ]
          }
        }
      );
      break;
      
    case '๐ผ ะะธะทะฝะตั ะบัะตะดะธั':
      bot.sendMessage(chatId, 
        `๐ผ ะัะตะดะธั ะดะปั ะฑะธะทะฝะตัะฐ:\n\n๐ฐ ะกัะผะผะฐ: ะดะพ 100,000,000 โธ\nโฐ ะกัะพะบ: ะดะพ 5 ะปะตั\n๐ ะกัะฐะฒะบะฐ: ะพั 12,50% ะณะพะดะพะฒัั\n๐ผ ะัะณะพัะฝัะน ะฟะตัะธะพะด: ะดะพ 6 ะผะตัััะตะฒ\n\nโ ะะตะท ะทะฐะปะพะณะฐ\nโ ะะฝะดะธะฒะธะดัะฐะปัะฝัะน ะฟะพะดัะพะด\nโ ะััััะพะต ัะตัะตะฝะธะต\nโ ะะธะฑะบะธะต ััะปะพะฒะธั\n\nะะฐะทะฒะธะฒะฐะนัะต ะฑะธะทะฝะตั ั ะฝะฐะผะธ!`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะะพะดะฐัั ะทะฐัะฒะบั', url: `${WEBSITE_URL}/#application` }],
              [{ text: '๐งฎ ะะฐัััะธัะฐัั ะฟะปะฐัะตะถ', url: `${WEBSITE_URL}/#credit-calculator` }]
            ]
          }
        }
      );
      break;
      
    // ะะตะฟะพะทะธัะฝัะต ะฟัะพะดัะบัั
    case '๐ ะะฐัะผะตั ะดะตะฟะพะทะธั':
      bot.sendMessage(chatId, 
        `๐ ะะฐัะผะตั ะดะตะฟะพะทะธั:\n\n๐ฐ ะะธะฝะธะผะฐะปัะฝะฐั ััะผะผะฐ: 100,000 โธ\nโฐ ะกัะพะบ: 3, 6, 12 ะผะตัััะตะฒ\n๐ ะกัะฐะฒะบะฐ: ะดะพ 17,80% ะณะพะดะพะฒัั\n๐ ะะพะฟะพะปะฝัะตะผัะน ะดะตะฟะพะทะธั\n\nโ ะััะพะบะธะน ะฟัะพัะตะฝั\nโ ะะธะฑะบะธะต ััะปะพะฒะธั\nโ ะะฐะดะตะถะฝะฐั ะทะฐัะธัะฐ\nโ ะะถะตะผะตัััะฝัะต ะฒัะฟะปะฐัั\n\nะะฐัะฝะธัะต ะบะพะฟะธัั ัะถะต ัะตะณะพะดะฝั!`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '๐ ะัะบัััั ะดะตะฟะพะทะธั', url: `${WEBSITE_URL}/#application` }],
              [{ text: '๐งฎ ะะฐัััะธัะฐัั ะดะพัะพะด', url: `${WEBSITE_URL}/#credit-calculator` }]
            ]
          }
        }
      );
      break;
      
    case '๐ ะะฐะทะฐะด ะฒ ะผะตะฝั':
      userStates.set(userId, 'main');
      bot.sendMessage(chatId, '๐ ะะปะฐะฒะฝะพะต ะผะตะฝั:', mainMenu);
      break;
      
    default:
      // ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐะฟะธัะฐะป ััะพ-ัะพ ะฝะตะพะถะธะดะฐะฝะฝะพะต
      if (userState === 'credits') {
        bot.sendMessage(chatId, 'ะัะฑะตัะธัะต ัะธะฟ ะบัะตะดะธัะฐ ะธะท ะผะตะฝั ะฝะธะถะต:', creditMenu);
      } else if (userState === 'deposits') {
        bot.sendMessage(chatId, 'ะัะฑะตัะธัะต ัะธะฟ ะดะตะฟะพะทะธัะฐ ะธะท ะผะตะฝั ะฝะธะถะต:', depositMenu);
      } else {
        bot.sendMessage(chatId, 
          `๐ค ะะต ะฟะพะฝะธะผะฐั ะฒะฐั ะทะฐะฟัะพั. ะัะฟะพะปัะทัะนัะต ะผะตะฝั ะฝะธะถะต ะธะปะธ ะฝะฐะฟะธัะธัะต /start ะดะปั ะฟะตัะตะทะฐะฟััะบะฐ.`,
          mainMenu
        );
      }
      break;
  }
});

// ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
bot.on('polling_error', (error) => {
  console.error('Polling error:', error);
});

bot.on('error', (error) => {
  console.error('Bot error:', error);
});

console.log('๐ค Telegram Bot ะทะฐะฟััะตะฝ ะธ ะณะพัะพะฒ ะบ ัะฐะฑะพัะต!');
console.log('๐ฑ ะะพั: @ExpensiveFinanceBot');
console.log('๐ ะกะฐะนั:', WEBSITE_URL);

module.exports = bot;
